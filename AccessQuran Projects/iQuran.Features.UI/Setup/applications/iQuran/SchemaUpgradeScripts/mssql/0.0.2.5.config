-- =============================================
-- Description:	Stored Procedures
-- =============================================

/****** Object:  StoredProcedure [dbo].[itinfo_iLib_Select_Root]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iLib_Select_Root]


/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-02
Last Modified:		2015-04-16
*/

@SiteID			int,
@QuranID			int

AS


SELECT     [Root]
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID)
GROUP BY [Root]
ORDER BY [Root]



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_Decrement_SuraCount]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_Decrement_SuraCount]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int,
@QuranID		int

AS

UPDATE		itinfo_Quran

SET			SuraCount = SuraCount - 1

WHERE		SiteID = @SiteID  AND QuranID = @QuranID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_DefaultExists]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuran_DefaultExists]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-03-30
*/

@SiteID			int

AS

IF EXISTS (	SELECT 	QuranID
FROM		itinfo_Quran
WHERE	(SiteID = @SiteID)
AND (IsDefault = 1 ))
SELECT 1
ELSE
SELECT 0



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_Delete]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_Delete]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-02
*/

@SiteID			int,
@QuranID		int

AS

DELETE FROM itinfo_Quran
WHERE SiteID = @SiteID AND QuranID = @QuranID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_DeleteBySite]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_DeleteBySite]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int

AS

DELETE FROM itinfo_QuranVersesTranslation
WHERE SiteID = @SiteID

DELETE FROM itinfo_QuranVersesText
WHERE SiteID = @SiteID

DELETE FROM itinfo_QuranVerses
WHERE SiteID = @SiteID

DELETE FROM itinfo_QuranSura
WHERE SiteID = @SiteID

DELETE FROM itinfo_Quran
WHERE SiteID = @SiteID



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_Exists]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_Exists]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-14
*/

@SiteID			int,
@QuranID		int,
@QLanguage		nchar(10),
@Title			nvarchar(250)

AS

if (@QuranID > 0)
Begin
-- edit
IF EXISTS (
SELECT 	QuranID
FROM		itinfo_Quran
WHERE	(SiteID = @SiteID)
AND (QLanguage = @QLanguage )
AND (Title = ltrim(rtrim(@Title)))
AND (QuranID <> @QuranID)
)
SELECT 1
ELSE
SELECT 0

end
else
Begin
-- add new
IF EXISTS (
SELECT 	QuranID
FROM		itinfo_Quran
WHERE	(SiteID = @SiteID)
AND (QLanguage = @QLanguage )
AND (Title = ltrim(rtrim(@Title)))
)
SELECT 1
ELSE
SELECT 0
end

GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_FrontEnd_SelectPage]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[itinfo_iQuran_FrontEnd_SelectPage]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-05-06
Last Modified:		2015-05-06
*/

@SiteID				int,
@QuranID			int,
@PageNumber 	int,
@IsTranslation bit

AS

if (@IsTranslation = 1)
Begin

SELECT  t1.*, t1.VerseOrder as VerseNo
FROM	itinfo_View_iSearch_Translation AS t1
WHERE
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID) AND (t1.PageNumber = @PageNumber)
ORDER BY t1.PageNumber

End
Else
Begin

SELECT  t1.*, t1.VerseOrder as VerseNo
FROM	itinfo_View_iSearch_Default AS t1
WHERE
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID)  AND (t1.PageNumber = @PageNumber)
ORDER BY t1.PageNumber

End


GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_FrontEnd_SelectPage_Header]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuran_FrontEnd_SelectPage_Header]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-05-07
Last Modified:		2015-05-07
*/

@SiteID				int,
@QuranID			int,
@PageNumber 	int,
@IsTranslation bit

AS
DECLARE @PartNo int, @Titles nvarchar(250)

if (@IsTranslation = 1)
Begin

SET @PartNo = (SELECT     PartNo
FROM         itinfo_QuranVersesTranslation 
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (PageNumber = @PageNumber)
GROUP BY PartNo)


SET @Titles = (SELECT    DISTINCT '   -   ' +  itinfo_QuranSura.Title  AS [text()]  
FROM         itinfo_QuranSura INNER JOIN
                      itinfo_QuranVersesTranslation ON itinfo_QuranSura.SuraID = itinfo_QuranVersesTranslation.SuraID
WHERE     (itinfo_QuranVersesTranslation.PageNumber = @PageNumber) AND(itinfo_QuranVersesTranslation.SiteID = @SiteID) AND (itinfo_QuranVersesTranslation.QuranID = @QuranID)
GROUP BY itinfo_QuranSura.Title
For XML PATH (''))

Select @PartNo as PartNo, @Titles as Titles


End
Else
Begin

SET @PartNo = (SELECT     PartNo
FROM         itinfo_QuranVerses 
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (PageNumber = @PageNumber)
GROUP BY PartNo)

SET @Titles = (SELECT    DISTINCT '   -   '+  itinfo_QuranSura.Title  AS [text()]  
FROM         itinfo_QuranSura INNER JOIN
                      itinfo_QuranVerses ON itinfo_QuranSura.SuraID = itinfo_QuranVerses.SuraID
WHERE     (itinfo_QuranVerses.PageNumber = @PageNumber) AND (itinfo_QuranVerses.SiteID = @SiteID) AND (itinfo_QuranVerses.QuranID = @QuranID)
GROUP BY itinfo_QuranSura.Title
For XML PATH (''))

Select @PartNo as PartNo, @Titles as Titles

End



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_GetCount]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_GetCount]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@IsAdmin		bit

AS
if (@IsAdmin = 1)
Begin
SELECT    COUNT(QuranID)
FROM         itinfo_Quran
WHERE     (SiteID = @SiteID)
End
Else
Begin
SELECT    COUNT(QuranID)
FROM         itinfo_Quran
WHERE     (SiteID = @SiteID) AND (IsActive = 1)
End




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_GetCount_SearchByCriteriaActive]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_GetCount_SearchByCriteriaActive]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@IsActive		bit

AS



SELECT    COUNT(QuranID)
FROM         itinfo_Quran
WHERE     (SiteID = @SiteID)
AND(IsActive = @IsActive)




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_GetCount_SearchByTitle]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_GetCount_SearchByTitle]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@IsAdmin		bit,
@Title nvarchar(250)

AS
if (@IsAdmin = 1)
Begin
SELECT    COUNT(QuranID)
FROM         itinfo_Quran
WHERE     (SiteID = @SiteID)
AND(Title LIKE N'%' + @Title + '%')
End
Else
Begin
SELECT    COUNT(QuranID)
FROM         itinfo_Quran
WHERE     (SiteID = @SiteID) AND (IsActive = 1)
AND(Title LIKE N'%' + @Title + '%')
End




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_Increment_SuraCount]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_Increment_SuraCount]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int,
@QuranID		int

AS

UPDATE		itinfo_Quran

SET			SuraCount = SuraCount + 1

WHERE		SiteID = @SiteID  AND QuranID = @QuranID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_Insert]    Script Date: 05/09/2015 17:35:48 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuran_Insert]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-05
*/

@SiteID			int,
@Title			nvarchar(250),
@Description	nvarchar(max),
@IsDefault		bit,
@QLanguage		nchar(10),
@IsActive		bit,
@TRanslatorDetUrl nvarchar(max),
@TranslationSrc  nvarchar(250),
@CreatedBy		int


AS


DECLARE @CreatedDate datetime, @SuraCount int

SET @CreatedDate = GETDATE()
SET @SuraCount = 0

INSERT INTO			itinfo_Quran
(
SiteID,Title , [Description],
IsDefault, QLanguage, IsActive,TRanslatorDetUrl,
TranslationSrc, CreatedBy,
CreatedDate, SuraCount

)

VALUES
(
@SiteID, @Title ,@Description ,
@IsDefault, @QLanguage, @IsActive,@TRanslatorDetUrl,
@TranslationSrc, @CreatedBy,
@CreatedDate, @SuraCount

)

SELECT @@IDENTITY As QuranID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_SelectAll]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_SelectAll]


/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int

AS


SELECT		q.*,
u.[Name] AS UserName

FROM			itinfo_Quran q

LEFT OUTER JOIN	mp_Users u
ON			q.CreatedBy = u.UserID

WHERE		q.SiteID = @SiteID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_SelectOne]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuran_SelectOne]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int,
@QuranID		int

AS


SELECT		q.*,
u.[Name] AS UserName

FROM			itinfo_Quran q

LEFT OUTER JOIN	mp_Users u
ON			q.CreatedBy = u.UserID

WHERE		q.SiteID = @SiteID  AND q.QuranID = @QuranID





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_SelectPage]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuran_SelectPage]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-10
*/

@SiteID			int,
@IsAdmin		bit,
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
QuranID Int
)

BEGIN

INSERT INTO #PageIndex (QuranID)
SELECT QuranID
FROM itinfo_Quran
WHERE SiteID =@SiteID
ORDER BY Title


END


SELECT     t1.*,
u.[Name] AS UserName

FROM         itinfo_Quran AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

JOIN			#PageIndex t2
ON
t1.QuranID = t2.QuranID

WHERE
t2.IndexID > @PageLowerBound
AND t2.IndexID < @PageUpperBound
AND (t1.IsActive = case when  @IsAdmin = 1 then t1.IsActive else 1 end)
		
ORDER BY t2.IndexID

DROP TABLE #PageIndex





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_SelectPage_SearchByCriteriaActive]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuran_SelectPage_SearchByCriteriaActive]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-10
*/

@SiteID			int,
@PageNumber 	int,
@PageSize 		int,
@IsActive			bit

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
QuranID Int
)

BEGIN

INSERT INTO #PageIndex (QuranID)
SELECT QuranID
FROM itinfo_Quran
WHERE (SiteID =@SiteID)
		AND (IsActive = @IsActive )
ORDER BY Title

END


SELECT     t1.*,
u.[Name] AS UserName

FROM         itinfo_Quran AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

JOIN			#PageIndex t2
ON t1.QuranID = t2.QuranID
WHERE t2.IndexID > @PageLowerBound
AND t2.IndexID < @PageUpperBound
ORDER BY t2.IndexID


DROP TABLE #PageIndex






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_SelectPage_SearchByTitle]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuran_SelectPage_SearchByTitle]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-10
*/

@SiteID			int,
@IsAdmin		bit,
@Title			nvarchar(250),
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
QuranID Int
)

BEGIN

INSERT INTO #PageIndex (QuranID)
SELECT QuranID
FROM itinfo_Quran
WHERE (SiteID =@SiteID)
		AND (Title LIKE N'%' + @Title + '%')
		AND (IsActive = case when  @IsAdmin = 1 then IsActive else 1 end)
ORDER BY Title

END


SELECT     t1.*,
u.[Name] AS UserName

FROM         itinfo_Quran AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID
JOIN			#PageIndex t2
ON t1.QuranID = t2.QuranID
WHERE t2.IndexID > @PageLowerBound
AND t2.IndexID < @PageUpperBound
ORDER BY t2.IndexID

DROP TABLE #PageIndex





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuran_Update]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuran_Update]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-05
*/

@SiteID			int,
@QuranID		int,
@Title			nvarchar(250),
@Description	nvarchar(max),
@IsDefault		bit,
@QLanguage		nchar(10),
@IsActive		bit,
@TRanslatorDetUrl nvarchar(max),
@TranslationSrc  nvarchar(250),
@CreatedBy		int


AS


UPDATE		itinfo_Quran

SET
Title =@Title,
[Description] = @Description,
IsDefault = @IsDefault,
QLanguage = @QLanguage,
IsActive = @IsActive,
TRanslatorDetUrl = @TRanslatorDetUrl,
TranslationSrc = @TranslationSrc,
CreatedBy = @CreatedBy

WHERE		SiteID = @SiteID AND  QuranID = @QuranID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_Decrement_VerseCount]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_Decrement_VerseCount]
/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@QuranID		int,
@SuraID			int

AS

UPDATE		itinfo_QuranSura
SET			VersesCount = VersesCount - 1
WHERE		SiteID = @SiteID  AND QuranID = @QuranID  AND SuraID = @SuraID



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_Delete]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_Delete]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-02
*/

@SiteID			int,
@QuranID		int,
@SuraID			int


AS


DELETE FROM itinfo_QuranSura
WHERE SiteID = @SiteID AND QuranID = @QuranID AND SuraID = @SuraID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_Exists]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_Exists]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-14
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@Title			nvarchar(250)

AS

if (@SuraID	> 0)
Begin
-- edit

IF EXISTS (	
SELECT 	SuraID
FROM		itinfo_QuranSura
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (Title = ltrim(rtrim(@Title)))
AND (SuraID <> @SuraID)
)
SELECT 1
ELSE
SELECT 0

end
else
Begin
--add new

IF EXISTS (
SELECT 	SuraID
FROM		itinfo_QuranSura
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (Title = ltrim(rtrim(@Title)))
)
SELECT 1
ELSE
SELECT 0

End




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_FrontEnd_Select_SurasIndex]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranSura_FrontEnd_Select_SurasIndex]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-05-06
Last Modified:		2015-05-06
*/

@SiteID			int,
@QuranID		int

AS



SELECT		qs.*,
u.[Name] AS UserName

FROM			itinfo_QuranSura qs

LEFT OUTER JOIN	mp_Users u
ON			qs.CreatedBy = u.UserID

WHERE		qs.SiteID = @SiteID  AND qs.QuranID = @QuranID
Order By qs.SuraOrder



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_FrontEnd_SelectSura]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_FrontEnd_SelectSura]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-25
Last Modified:		2015-04-25
*/

@SiteID				int,
@QuranID			int,
@SuraID		int,
@PageNumber 	int,
@IsTranslation bit

AS


if (@IsTranslation = 1)
Begin


SELECT  *
FROM	itinfo_View_iSearch_Translation as t1
WHERE 
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID)  AND (t1.SuraID = @SuraID)
AND (t1.PageNumber = CASE WHEN @PageNumber = 0 THEN t1.PageNumber ELSE @PageNumber END) 
Order By VerseOrder

End
Else
Begin

SELECT  *
FROM	itinfo_View_iSearch_Default as t1
WHERE 
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID)  AND (t1.SuraID = @SuraID)
AND (t1.PageNumber = CASE WHEN @PageNumber = 0 THEN t1.PageNumber ELSE @PageNumber END) 
Order By VerseOrder

End







GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_GetCount]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranSura_GetCount]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@QuranID		int,
@IsAdmin		bit

AS
if (@IsAdmin = 1)
Begin
SELECT    COUNT(SuraID)
FROM         itinfo_QuranSura
WHERE     (SiteID = @SiteID AND QuranID = @QuranID)
End
Else
Begin
SELECT    COUNT(SuraID)
FROM         itinfo_QuranSura
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (IsActive = 1)
End




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_GetCount_SearchByCriteriaActive]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_GetCount_SearchByCriteriaActive]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@QuranID		int,
@IsActive		bit

AS

SELECT    COUNT(SuraID)
FROM         itinfo_QuranSura
WHERE     (SiteID = @SiteID AND QuranID = @QuranID)
AND(IsActive = @IsActive)




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_GetCount_SearchByTitle]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_GetCount_SearchByTitle]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@QuranID		int,
@IsAdmin		bit,
@Title nvarchar(250)

AS
if (@IsAdmin = 1)
Begin
SELECT    COUNT(SuraID)
FROM         itinfo_QuranSura
WHERE     (SiteID = @SiteID AND QuranID = @QuranID)
AND(Title LIKE N'%' + @Title + '%')
End
Else
Begin
SELECT    COUNT(SuraID)
FROM         itinfo_QuranSura
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (IsActive = 1)
AND(Title LIKE N'%' + @Title + '%')
End




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_GetSuraID_FromPageNumber]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranSura_GetSuraID_FromPageNumber]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-05-09
Last Modified:		2015-05-09
*/

@SiteID			int,
@QuranID			int,
@PageNumber	int,
@IsTranslation bit

AS


if (@IsTranslation = 1)
Begin


SELECT     MIN(SuraID) AS uraID
FROM         itinfo_QuranVersesTranslation
WHERE     (SiteID = @SiteID AND QuranID = @QuranID AND PageNumber=@PageNumber)
GROUP BY SuraID

End
Else
Begin


SELECT    TOP(1) SuraID  
FROM         itinfo_QuranVerses
WHERE     (SiteID = @SiteID AND QuranID = @QuranID AND PageNumber=@PageNumber)
GROUP BY SuraID




End










GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_Increment_VersesCount]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_Increment_VersesCount]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-30
*/

@SiteID			int,
@QuranID		int,
@SuraID			int

AS

UPDATE		itinfo_QuranSura
SET			VersesCount = VersesCount + 1
WHERE		SiteID = @SiteID  AND QuranID = @QuranID  AND SuraID = @SuraID



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_Insert]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE PROCEDURE [dbo].[itinfo_iQuranSura_Insert]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-14

*/

@SiteID			int,
@QuranID		int,
@Title			nvarchar(250),
@Place			nvarchar(50),
@SuraOrder		int,
@IsActive		bit,
@CreatedBy		int


AS

DECLARE @CreatedDate datetime, @VersesCount int

SET @CreatedDate = GETDATE()
SET @VersesCount =0

INSERT INTO			itinfo_QuranSura
(
SiteID, QuranID, Title, Place, VersesCount, SuraOrder ,
IsActive, CreatedBy,
Createddate

)

VALUES
(
@SiteID, @QuranID, @Title, @Place, 0, @SuraOrder ,
@IsActive, @CreatedBy,
GETDATE()

)

SELECT @@IDENTITY As SuraID






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_OrderExists]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_OrderExists]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-14
Last Modified:		2015-04-14
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@SuraOrder		int

AS

if (@SuraID	> 0)
Begin
-- edit

IF EXISTS (
SELECT 	SuraID
FROM		itinfo_QuranSura
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraOrder = @SuraOrder)
AND (SuraID <> @SuraID)
)
SELECT 1
ELSE
SELECT 0

end
else
Begin
--add new

IF EXISTS (
SELECT 	SuraID
FROM		itinfo_QuranSura
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraOrder = @SuraOrder)
)
SELECT 1
ELSE
SELECT 0

End




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_SelectAll]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranSura_SelectAll]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-11
*/

@SiteID			int,
@QuranID		int

AS


SELECT		qs.*,
u.[Name] AS UserName

FROM			itinfo_QuranSura qs

LEFT OUTER JOIN	mp_Users u
ON			qs.CreatedBy = u.UserID

WHERE		qs.SiteID = @SiteID  AND qs.QuranID = @QuranID





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_SelectOne]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_SelectOne]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int,
@SuraID		int

AS


SELECT		qs.*,
u.[Name] AS UserName

FROM			itinfo_QuranSura qs

LEFT OUTER JOIN	mp_Users u
ON			qs.CreatedBy = u.UserID

WHERE		qs.SiteID = @SiteID  AND qs.SuraID = @SuraID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_SelectPage]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_SelectPage]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-11
*/

@SiteID			int,
@QuranID		int,
@IsAdmin		bit,
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
SuraID Int
)

BEGIN

INSERT INTO #PageIndex (SuraID)
SELECT SuraID
FROM itinfo_QuranSura
WHERE (SiteID =@SiteID) AND (QuranID =@QuranID)
AND (IsActive = case when  @IsAdmin = 1 then IsActive else 1 end)
ORDER BY SuraOrder


END


SELECT     t1.*,
u.[Name] AS UserName
FROM         itinfo_QuranSura AS t1
LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

JOIN			#PageIndex t2
ON t1.SuraID = t2.SuraID
WHERE
t2.IndexID > @PageLowerBound
AND t2.IndexID < @PageUpperBound
ORDER BY t2.IndexID

DROP TABLE #PageIndex






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_SelectPage_SearchByCriteriaActive]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranSura_SelectPage_SearchByCriteriaActive]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-11
*/

@SiteID			int,
@QuranID		int,
@PageNumber 	int,
@PageSize 		int,
@IsActive			bit

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
SuraID Int
)

BEGIN

INSERT INTO #PageIndex (SuraID)
SELECT SuraID
FROM itinfo_QuranSura
WHERE (SiteID =@SiteID) AND (QuranID =@QuranID)
		AND (IsActive = @IsActive )
ORDER BY SuraOrder

END


SELECT     t1.*,
u.[Name] AS UserName
FROM         itinfo_QuranSura AS t1 
LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

JOIN			#PageIndex t2
ON t1.SuraID = t2.SuraID
WHERE t2.IndexID > @PageLowerBound
AND t2.IndexID < @PageUpperBound
ORDER BY t2.IndexID


DROP TABLE #PageIndex







GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_SelectPage_SearchByTitle]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranSura_SelectPage_SearchByTitle]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-11
*/

@SiteID			int,
@QuranID		int,
@IsAdmin		bit,
@Title			nvarchar(250),
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
SuraID Int
)

BEGIN

INSERT INTO #PageIndex (SuraID)
SELECT SuraID
FROM itinfo_QuranSura
WHERE (SiteID =@SiteID) AND (QuranID =@QuranID)
		AND (Title LIKE N'%' + @Title + '%')
		AND (IsActive = case when  @IsAdmin = 1 then IsActive else 1 end)
ORDER BY SuraOrder

END


SELECT     t1.*,
u.[Name] AS UserName
FROM         itinfo_QuranSura AS t1 
LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

JOIN			#PageIndex t2
ON t1.SuraID = t2.SuraID
WHERE t2.IndexID > @PageLowerBound
AND t2.IndexID < @PageUpperBound
ORDER BY t2.IndexID

DROP TABLE #PageIndex






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_Update]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







CREATE PROCEDURE [dbo].[itinfo_iQuranSura_Update]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-12
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@Title			nvarchar(250),
@Place			nvarchar(50),
@SuraOrder		int,
@IsActive		bit,
@CreatedBy		int


AS


UPDATE		itinfo_QuranSura

SET
Title = @Title,
Place = @Place,
SuraOrder = @SuraOrder,
IsActive = @IsActive,
CreatedBy = @CreatedBy
WHERE		SiteID = @SiteID AND  QuranID = @QuranID AND SuraID = @SuraID






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_Verse_Default_GetID]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranSura_Verse_Default_GetID]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-13
Last Modified:		2015-04-13
*/

@SiteID			int,
@SuraOrder		int,
@OrigVerseOrder int

AS

DECLARE @QuranID		int

SET @QuranID = (SELECT QuranID from  itinfo_Quran where IsDefault=1)

SELECT		VerseID

FROM			itinfo_QuranVerses
WHERE		SiteID = @SiteID  AND QuranID = @QuranID 
AND SuraOrder=@SuraOrder AND VerseOrder = @OrigVerseOrder






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_VersesCount]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranSura_VersesCount]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int,
@SuraID			int

AS

SELECT    VersesCount
FROM         itinfo_QuranSura
WHERE     (SiteID = @SiteID AND SuraID = @SuraID)




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_VersesSelectAll]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranSura_VersesSelectAll]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-03-29
*/

@SiteID			int,
@SuraID		int

AS


SELECT		qsv.*,
u.[Name] AS UserName

FROM			itinfo_QuranVerses qsv

LEFT OUTER JOIN	mp_Users u
ON			qsv.CreatedBy = u.UserID

WHERE		qsv.SiteID = @SiteID  AND qsv.SuraID = @SuraID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranSura_VersesSelectAllText]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranSura_VersesSelectAllText]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-13
Last Modified:		2015-04-13
*/

@SiteID			int,
@SuraID		int

AS


SELECT		*

FROM			itinfo_QuranVersesText

WHERE		SiteID = @SiteID  AND SuraID = @SuraID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerse_Exists]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerse_Exists]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-14
Last Modified:		2015-04-14
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int,
@VerseTextNMAlif			nvarchar(MAX)

AS

if (@VerseID	> 0)
Begin
-- edit

IF EXISTS (	
SELECT 	VerseID
FROM		itinfo_QuranVersesText
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseTextNMAlif = ltrim(rtrim(@VerseTextNMAlif)))
AND (VerseID <> @VerseID)
)
SELECT 1
ELSE
SELECT 0

end
else
Begin
--add new

IF EXISTS (
SELECT 	VerseID
FROM		itinfo_QuranVersesText
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseTextNMAlif = ltrim(rtrim(@VerseTextNMAlif)))
)
SELECT 1
ELSE
SELECT 0

End





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerse_Exists_Translation]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerse_Exists_Translation]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-14
Last Modified:		2015-04-14
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int,
@VerseText			nvarchar(MAX)

AS

if (@VerseID	> 0)
Begin
-- edit

IF EXISTS (
SELECT 	VerseID
FROM		itinfo_QuranVersesTranslation
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseText = ltrim(rtrim(@VerseText)))
AND (VerseID <> @VerseID)
)
SELECT 1
ELSE
SELECT 0

end
else
Begin
--add new

IF EXISTS (
SELECT 	VerseID
FROM		itinfo_QuranVersesTranslation
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseText = ltrim(rtrim(@VerseText)))
)
SELECT 1
ELSE
SELECT 0

End





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerse_OrderExists]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerse_OrderExists]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-14
Last Modified:		2015-04-14
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int,
@VerseOrder		int

AS

if (@VerseID> 0)
Begin
-- edit

IF EXISTS (
SELECT 	VerseID
FROM		itinfo_QuranVersesText
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseOrder = @VerseOrder)
AND (VerseID<> @VerseID)
)
SELECT 1
ELSE
SELECT 0

end
else
Begin
--add new

IF EXISTS (
SELECT 	VerseID
FROM		itinfo_QuranVersesText
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseOrder = @VerseOrder)
)
SELECT 1
ELSE
SELECT 0

End





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerse_OrderExists_Translation]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerse_OrderExists_Translation]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-14
Last Modified:		2015-04-14
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int,
@VerseOrder		int

AS

if (@VerseID> 0)
Begin
-- edit

IF EXISTS (
SELECT 	VerseID
FROM		itinfo_QuranVersesTranslation
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseOrder = @VerseOrder)
AND (VerseID<> @VerseID)
)
SELECT 1
ELSE
SELECT 0

end
else
Begin
--add new

IF EXISTS (
SELECT 	VerseID
FROM		itinfo_QuranVersesTranslation
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID = @SuraID)
AND (VerseOrder = @VerseOrder)
)
SELECT 1
ELSE
SELECT 0

End





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_Delete]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_Delete]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-13
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int


AS


DELETE FROM itinfo_QuranVersesText
WHERE SiteID = @SiteID AND QuranID = @QuranID AND SuraID = @SuraID AND VerseID = @VerseID

DELETE FROM itinfo_QuranVerses
WHERE SiteID = @SiteID AND QuranID = @QuranID AND SuraID = @SuraID AND VerseID = @VerseID





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_Delete_Translation]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_Delete_Translation]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-13
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int


AS



DELETE FROM itinfo_QuranVersesTranslation
WHERE SiteID = @SiteID AND QuranID = @QuranID AND SuraID = @SuraID AND VerseID = @VerseID





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_GetCount]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_GetCount]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-12
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@IsTranslation	bit

AS

if (@IsTranslation = 1)
BEGIN
-- search within translations

SELECT     COUNT(VerseID) AS Expr1
FROM         itinfo_QuranVersesTranslation
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID = @SuraID)

END
ELSE
BEGIN
-- search within text

SELECT     COUNT(VerseID) AS Expr1
FROM         itinfo_QuranVersesText
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID = @SuraID)

END






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_GetCount_SearchByCriteriaActive]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_GetCount_SearchByCriteriaActive]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-12
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@IsActive		bit,
@IsTranslation	bit

AS

if (@IsTranslation = 1)
BEGIN
-- search within translations
SELECT     COUNT(itinfo_QuranVersesTranslation.VerseID) AS Expr1
FROM         itinfo_QuranVersesTranslation INNER JOIN
itinfo_QuranVerses ON
itinfo_QuranVersesTranslation.VerseID = itinfo_QuranVerses.VerseID
WHERE     (itinfo_QuranVersesTranslation.SiteID = @SiteID)
AND (itinfo_QuranVersesTranslation.QuranID = @QuranID)
AND (itinfo_QuranVersesTranslation.SuraID = @SuraID) AND
(itinfo_QuranVerses.IsActive = @IsActive)

END
ELSE
BEGIN
-- search within text

SELECT     COUNT(itinfo_QuranVersesText.VerseID) AS Expr1
FROM         itinfo_QuranVersesText INNER JOIN
itinfo_QuranVerses ON
itinfo_QuranVersesText.VerseID = itinfo_QuranVerses.VerseID
WHERE     (itinfo_QuranVersesText.SiteID = @SiteID)
AND (itinfo_QuranVersesText.QuranID = @QuranID)
AND (itinfo_QuranVersesText.SuraID = @SuraID) AND
(itinfo_QuranVerses.IsActive = @IsActive)

END





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_GetCount_SearchByTitle]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_GetCount_SearchByTitle]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-12
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@IsTranslation	bit,
@Title			nvarchar(250)

AS

if (@IsTranslation = 1)
BEGIN
-- search within translations

SELECT     COUNT(VerseID) AS Expr1
FROM         itinfo_QuranVersesTranslation
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID = @SuraID)
GROUP BY VerseText
HAVING      (VerseText LIKE N'%' + @Title + '%')

END
ELSE
BEGIN
-- search within text

SELECT     COUNT(VerseID) AS Expr1
FROM         itinfo_QuranVersesText
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID = @SuraID)
GROUP BY VerseTextNM
HAVING      (VerseTextNM LIKE N'%' + @Title + '%')

END





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_GetVerse_PageNumber]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_GetVerse_PageNumber]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-05-06
Last Modified:		2015-05-06
*/

@SiteID			int,
@SuraID		int,
@VerseID	int

AS

SELECT     PageNumber
FROM         itinfo_QuranVerses
WHERE     (SiteID = @SiteID) AND (VerseID = @VerseID)


GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_InsertText]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_InsertText]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-06
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseOrder		int,
@SuraOrder		int,
@HalfNo			int,
@PartNo			int,
@HizbNo			int,
@QuraterNo		int,
@Place			nvarchar(50),
@StartTime		float,
@EndTime		float,
@EndTimeText	nvarchar(50),
@IsActive		bit,
@CreatedBy		int,
@VerseText		nvarchar(MAX),
@VerseTextNM	nvarchar(MAX),
@VerseTextNMAlif	nvarchar(MAX)


AS

DECLARE @CreatedDate datetime, @SortOrderInQuran int, @IDD int

SET @CreatedDate = GETDATE()

SET @SortOrderInQuran = (SELECT MAX(SortOrderInQuran) FROM itinfo_QuranVerses
WHERE SiteID = @SiteID AND QuranID = @QuranID AND SuraID = @SuraID) + 1


INSERT INTO			itinfo_QuranVerses
(
SiteID, QuranID, SuraID, VerseOrder,SuraOrder, HalfNo, PartNo, HizbNo, QuraterNo, Place,
StartTime, EndTime, EndTimeText, IsActive, CreatedBy,
CreatedDate, SortOrderInQuran
)

VALUES
(
@SiteID, @QuranID, @SuraID, @VerseOrder,@SuraOrder, @HalfNo, @PartNo, @HizbNo, @QuraterNo, @Place,
@StartTime, @EndTime, @EndTimeText, @IsActive, @CreatedBy,
@CreatedDate, @SortOrderInQuran

)

-- SELECT @@IDENTITY As VerseID
SET @IDD = @@IDENTITY

INSERT INTO			itinfo_QuranVersesText
(
SiteID , QuranID , SuraID , VerseID , SuraOrder , VerseOrder,
VerseText, VerseTextNM, VerseTextNMAlif
)

VALUES
(
@SiteID , @QuranID , @SuraID ,  @IDD , @SuraOrder , @VerseOrder,
@VerseText, @VerseTextNM, @VerseTextNMAlif
)



SELECT @IDD As VerseID


GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_InsertTransl]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_InsertTransl]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int,
@SuraOrder		int,
@VerseOrder		int,
@VerseText		nvarchar(MAX)

AS


INSERT INTO			itinfo_QuranVersesTranslation
(
SiteID, QuranID, SuraID, VerseID, SuraOrder, VerseOrder, VerseText
)

VALUES
(
@SiteID, @QuranID, @SuraID,  @VerseID, @SuraOrder, @VerseOrder, @VerseText
)


SELECT @VerseID





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_Select_Text]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_Select_Text]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int


AS

SELECT		*
FROM			itinfo_QuranVersesText
WHERE		SiteID = @SiteID  AND QuranID = @QuranID AND SuraID = @SuraID AND VerseID = @VerseID





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_Select_Translation]    Script Date: 05/09/2015 17:35:49 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_Select_Translation]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-12
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int


AS

SELECT		VerseText
FROM			itinfo_QuranVersesTranslation
WHERE		SiteID = @SiteID  AND QuranID = @QuranID AND SuraID = @SuraID AND VerseID = @VerseID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_Select_Translation_Details]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_Select_Translation_Details]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-13
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@VerseID		int


AS

SELECT		*
FROM			itinfo_QuranVersesTranslation
WHERE		SiteID = @SiteID  AND QuranID = @QuranID  AND VerseID = @VerseID





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_Select_VerseBism]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_Select_VerseBism]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-05-06
Last Modified:		2015-05-06
*/

@SiteID			int,
@QuranID		int,
@IsTranslation  bit

AS

if (@IsTranslation = 1)
Begin

SELECT     VerseText
FROM         itinfo_QuranVersesTranslation
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraOrder = 1)

End
Else
Begin

SELECT     VerseText
FROM         itinfo_QuranVersesText
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraOrder = 1)
End




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_SelectOne_Othmani]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_SelectOne_Othmani]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-034-13
Last Modified:		2015-034-13
*/

@SiteID			int,
@VerseID		int


AS


SELECT		qsv.*,
QVT.VerseText, QVT.VerseTextNM, QVT.VerseTextNMAlif,
u.[Name] AS UserName, q.QLanguage

FROM			itinfo_QuranVerses qsv

LEFT OUTER JOIN	mp_Users u
ON			qsv.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran q
ON			qsv.QuranID = q.QuranID

LEFT OUTER JOIN	itinfo_QuranVersesText QVT
ON			qsv.QuranID = QVT.QuranID
AND qsv.VerseID = QVT.VerseID

WHERE		qsv.SiteID = @SiteID
AND qsv.VerseID = @VerseID







GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_SelectOne_Translation]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_SelectOne_Translation]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-034-13
Last Modified:		2015-034-13
*/

@SiteID			int,
@QuranID			int,
@VerseID		int


AS


SELECT  t1.VerseID, t1.SiteID, t1.SuraID as OriginalSuraID, t1.QuranID as OriginalQuranID,
t1.VerseOrder, t1.SuraOrder, t1.SortOrderInQuran, t1.HalfNo,
t1.PartNo, t1.HizbNo, t1.QuraterNo, t1.Place,
t1.StartTime, t1.EndTime, t1.EndTimeText, t1.IsActive,
t1.CreatedDate, t1.CreatedBy,
u.[Name] AS UserName, Q.QLanguage, QVT.VerseText, QVT.QuranID, QVT.SuraID

FROM	itinfo_QuranVerses AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran Q
ON			t1.QuranID = Q.QuranID

LEFT OUTER JOIN itinfo_QuranVersesTranslation AS QVT
ON t1.VerseID = QVT.VerseID


--WHERE  QVT.SuraID =@SuraID
WHERE		t1.SiteID = @SiteID
AND QVT.QuranID = @QuranID
AND QVT.VerseID = @VerseID

/*
SELECT		qsv.*,
QVT.VerseText,
u.[Name] AS UserName, q.QLanguage

FROM			itinfo_QuranVerses qsv

LEFT OUTER JOIN	mp_Users u
ON			qsv.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran q
ON			qsv.QuranID = q.QuranID

LEFT OUTER JOIN	itinfo_QuranVersesTranslation QVT
ON qsv.VerseID = QVT.VerseID

WHERE		qsv.SiteID = @SiteID
AND QVT.QuranID = @QuranID
AND qsv.VerseID = @VerseID

*/





GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_SelectPage]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_SelectPage]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@IsTranslation	bit,
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseID Int

)

BEGIN

if (@IsTranslation = 1)
begin
INSERT INTO #PageIndex (VerseID)
SELECT     VerseID
FROM         itinfo_QuranVersesTranslation
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID = @SuraID)
ORDER BY SuraOrder,VerseOrder
end
else
begin
INSERT INTO #PageIndex (VerseID)
SELECT     VerseID
FROM         itinfo_QuranVersesText
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID = @SuraID)
ORDER BY SuraOrder,VerseOrder

end

END


if (@IsTranslation = 1)
BEGIN
-- search within translations

SELECT  t1.VerseID, t1.SiteID, t1.SuraID as OriginalSuraID, t1.QuranID as OriginalQuranID,
t1.VerseOrder, t1.SuraOrder, t1.SortOrderInQuran, t1.HalfNo,
t1.PartNo, t1.HizbNo, t1.QuraterNo, t1.Place,
t1.StartTime, t1.EndTime, t1.EndTimeText, t1.IsActive,
t1.CreatedDate, t1.CreatedBy,
u.[Name] AS UserName, Q.QLanguage, QVT.QuranID,QVT.SuraID,QVT.VerseText

FROM	itinfo_QuranVerses AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran Q
ON			t1.QuranID = Q.QuranID

LEFT OUTER JOIN itinfo_QuranVersesTranslation AS QVT
ON t1.VerseID = QVT.VerseID



INNER JOIN			#PageIndex As t2
ON t1.VerseID = t2.VerseID


WHERE  QVT.SuraID =@SuraID
AND (t2.IndexID > @PageLowerBound)
AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID


END

ELSE

BEGIN
-- search within text


SELECT  t1.*,
u.[Name] AS UserName, Q.QLanguage, QVT.*

FROM	itinfo_QuranVerses AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran Q
ON			t1.QuranID = Q.QuranID

	LEFT OUTER JOIN itinfo_QuranVersesText AS QVT
	ON t1.VerseID = QVT.VerseID
	
	INNER JOIN			#PageIndex As t2
	ON t1.VerseID = t2.VerseID 
WHERE
	(t2.IndexID > @PageLowerBound)
	AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID


END

DROP TABLE #PageIndex










GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_SelectPage_SearchByCriteriaActive]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_SelectPage_SearchByCriteriaActive]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@IsActive			bit,
@IsTranslation	bit,
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseID Int
)

BEGIN

if (@IsTranslation = 1)
begin
	INSERT INTO #PageIndex (VerseID)
	SELECT     QVT.VerseID
	FROM         itinfo_QuranVersesTranslation AS QVT LEFT OUTER JOIN
                      itinfo_QuranVerses  AS QV
                      ON QVT.VerseID = QV.VerseID
	WHERE     (QVT.SiteID = @SiteID) 
				AND (QVT.QuranID = @QuranID) 
				AND (QVT.SuraID = @SuraID) AND 
                      (QV.IsActive = @IsActive)
	ORDER BY QVT.SuraOrder, QVT.VerseOrder
end
else
begin
	INSERT INTO #PageIndex (VerseID)
	SELECT     QVT.VerseID
	FROM         itinfo_QuranVersesText AS QVT LEFT OUTER JOIN
                      itinfo_QuranVerses  AS QV
                      ON QVT.VerseID = QV.VerseID
	WHERE     (QVT.SiteID = @SiteID) 
				AND (QVT.QuranID = @QuranID) 
				AND (QVT.SuraID = @SuraID) AND 
                      (QV.IsActive = @IsActive)
	ORDER BY QVT.SuraOrder, QVT.VerseOrder
	
end

END


if (@IsTranslation = 1)
BEGIN
-- search within translations


SELECT  t1.VerseID, t1.SiteID, t1.SuraID as OriginalSuraID, t1.QuranID as OriginalQuranID, 
		t1.VerseOrder, t1.SuraOrder, t1.SortOrderInQuran, t1.HalfNo, 
		t1.PartNo, t1.HizbNo, t1.QuraterNo, t1.Place, 
		t1.StartTime, t1.EndTime, t1.EndTimeText, t1.IsActive, 
		t1.CreatedDate, t1.CreatedBy,
		u.[Name] AS UserName, Q.QLanguage, QVT.QuranID,QVT.SuraID,QVT.VerseText

FROM	itinfo_QuranVerses AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran Q
ON			t1.QuranID = Q.QuranID

	LEFT OUTER JOIN itinfo_QuranVersesTranslation AS QVT
	ON t1.VerseID = QVT.VerseID
	
	JOIN			#PageIndex As t2
	ON t1.VerseID = t2.VerseID 

WHERE QVT.SuraID =@SuraID
AND (t2.IndexID > @PageLowerBound)
	AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID

END

ELSE

BEGIN
-- search within text


SELECT  t1.*,
u.[Name] AS UserName, Q.QLanguage, QVT.*

FROM	itinfo_QuranVerses AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran Q
ON			t1.QuranID = Q.QuranID

	LEFT OUTER JOIN itinfo_QuranVersesText AS QVT
	ON t1.VerseID = QVT.VerseID
	
	JOIN			#PageIndex As t2
	ON t1.VerseID = t2.VerseID 

WHERE (t2.IndexID > @PageLowerBound)
	AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID


END


DROP TABLE #PageIndex











GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_SelectPage_SearchByTitle]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_SelectPage_SearchByTitle]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-30
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@IsTranslation	bit,
@Title			nvarchar(250),
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int


SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseID Int
)

BEGIN




if (@IsTranslation = 1)
begin
	INSERT INTO #PageIndex (VerseID)
	SELECT     QVT.VerseID
	FROM         itinfo_QuranVersesTranslation AS QVT LEFT OUTER JOIN
                      itinfo_QuranVerses 
                      ON QVT.VerseID = itinfo_QuranVerses.VerseID
	WHERE     (QVT.SiteID = @SiteID) 
				AND (QVT.QuranID = @QuranID) 
				AND (QVT.SuraID = @SuraID) 
				AND (QVT.VerseText LIKE N'%' + @Title + '%')
	ORDER BY QVT.SuraOrder, QVT.VerseOrder
end
else
begin
	INSERT INTO #PageIndex (VerseID)
	SELECT     QVT.VerseID
	FROM         itinfo_QuranVersesText AS QVT LEFT OUTER JOIN
                      itinfo_QuranVerses 
                      ON QVT.VerseID = itinfo_QuranVerses.VerseID
	WHERE     (QVT.SiteID = @SiteID) 
				AND (QVT.QuranID = @QuranID) 
				AND (QVT.SuraID = @SuraID) 
				AND (QVT.VerseTextNMAlif LIKE N'%' + @Title + '%')
	ORDER BY QVT.SuraOrder, QVT.VerseOrder
	
end

END



if (@IsTranslation = 1)
BEGIN
-- search within translations


SELECT  t1.VerseID, t1.SiteID, t1.SuraID as OriginalSuraID, t1.QuranID as OriginalQuranID, 
		t1.VerseOrder, t1.SuraOrder, t1.SortOrderInQuran, t1.HalfNo, 
		t1.PartNo, t1.HizbNo, t1.QuraterNo, t1.Place, 
		t1.StartTime, t1.EndTime, t1.EndTimeText, t1.IsActive, 
		t1.CreatedDate, t1.CreatedBy,
		u.[Name] AS UserName, Q.QLanguage, QVT.QuranID,QVT.SuraID,QVT.VerseText

FROM	itinfo_QuranVerses AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran Q
ON			t1.QuranID = Q.QuranID

	LEFT OUTER JOIN itinfo_QuranVersesTranslation as QVT
	ON t1.VerseID = QVT.VerseID
	
	JOIN			#PageIndex As t2
	ON t1.VerseID = t2.VerseID 

WHERE QVT.SuraID =@SuraID
AND (t2.IndexID > @PageLowerBound)
	AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID

END

ELSE

BEGIN
-- search within text


SELECT  t1.*,
u.[Name] AS UserName, Q.QLanguage, QVT.*

FROM	itinfo_QuranVerses AS t1

LEFT OUTER JOIN	mp_Users u
ON			t1.CreatedBy = u.UserID

LEFT OUTER JOIN	itinfo_Quran Q
ON			t1.QuranID = Q.QuranID

	LEFT OUTER JOIN itinfo_QuranVersesText as QVT
	ON t1.VerseID = QVT.VerseID
	
	JOIN			#PageIndex As t2
	ON t1.VerseID = t2.VerseID 

WHERE
	(t2.IndexID > @PageLowerBound)
	AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID


END


DROP TABLE #PageIndex










GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_Translation_CheckStatus]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_Translation_CheckStatus]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-13
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int

AS

IF EXISTS (	SELECT 	VerseID
FROM		itinfo_QuranVersesTranslation
WHERE	(SiteID = @SiteID)
AND (QuranID = @QuranID )
AND (SuraID	 = @SuraID	)
AND (VerseID = @VerseID ))
SELECT 1
ELSE
SELECT -1






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_UpdateText]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_UpdateText]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-06
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int,
@VerseOrder		int,
@SuraOrder		int,
@HalfNo			int,
@PartNo			int,
@HizbNo			int,
@QuraterNo		int,
@Place			nvarchar(50),
@StartTime		float,
@EndTime		float,
@EndTimeText	nvarchar(50),
@IsActive		bit,
@CreatedBy		int,
@VerseText		nvarchar(MAX),
@VerseTextNM	nvarchar(MAX),
@VerseTextNMAlif	nvarchar(MAX)


AS

UPDATE		itinfo_QuranVerses
SET
VerseOrder = @VerseOrder,
SuraOrder = @SuraOrder,
HalfNo = @HalfNo,
PartNo = @PartNo,
HizbNo = @HizbNo,
QuraterNo = @QuraterNo,
Place = @Place,
StartTime = @StartTime,
EndTime = @EndTime,
EndTimeText = @EndTimeText,
IsActive = @IsActive,
CreatedBy = @CreatedBy
WHERE		SiteID = @SiteID AND  QuranID = @QuranID AND SuraID = @SuraID AND @VerseID = VerseID


UPDATE			itinfo_QuranVersesText
SET
VerseText = @VerseText,
VerseTextNM = @VerseTextNM,
VerseTextNMAlif = @VerseTextNMAlif
WHERE		SiteID = @SiteID AND  QuranID = @QuranID AND SuraID = @SuraID AND @VerseID = VerseID




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iQuranVerses_UpdateTransl]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iQuranVerses_UpdateTransl]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-03-29
Last Modified:		2015-04-13
*/

@SiteID			int,
@QuranID		int,
@SuraID			int,
@VerseID		int,
@SuraOrder		int,
@VerseOrder		int,
@VerseText		nvarchar(MAX)


AS


UPDATE			itinfo_QuranVersesTranslation
SET
VerseOrder = @VerseOrder,
SuraOrder = @SuraOrder,
VerseText = @VerseText
WHERE		SiteID = @SiteID AND  QuranID = @QuranID AND SuraID = @SuraID AND @VerseID = VerseID



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByOnlyWord]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByOnlyWord]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-21
Last Modified:		2015-04-21
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20)

AS

-- @SearchCriteria : 
-- Word Dictional Criteria : DictNMAlif , DictNM 
-- Word Othmani Criteria : OthmNMAlif , OthmNM , Othm
-- DB FIELDS : WordOthmani , WordOthmaniNM , WordOthmaniNMAlif , WordDictNM , WordDictNMAlif



DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

SELECT     COUNT(WordID) AS WCount
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + '') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
	)










GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByOnlyWord_Dr]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByOnlyWord_Dr]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-21
Last Modified:		2015-04-21
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20)

AS

-- @SearchCriteria : 
-- Word Dictional Criteria : DictNMAlif , DictNM 
-- Word Othmani Criteria : OthmNMAlif , OthmNM , Othm
-- DB FIELDS : WordOthmani , WordOthmaniNM , WordOthmaniNMAlif , WordDictNM , WordDictNMAlif

DECLARE @WordQty int, @VerseQty int
DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int, @SearchedWords nvarchar(max)

-- get VERSE ORDER in WHOLE Quran
BEGIN

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

END


BEGIN


SET @WordQty = 
(
SELECT     COUNT(WordID) AS WCount
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + '') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
	)
)
END
 
-- get Verse Quantity : 
SET @VerseQty =
(
SELECT COUNT(VerseQty) 
FROM(
SELECT     COUNT(VerseID) AS VerseQty
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + '') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
	)
 GROUP BY VerseID
) AS Sql_Query1
)

-- to control the repeating of seperator '-'
-- if one word we do not need seperator

if (@WordQty > 1)
BEGIN
SET @SearchedWords =
(
SELECT     DISTINCT '-'+ WordOthmani  AS [text()] 
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
	AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
	AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM =  N'' + ltrim(rtrim(@TextSearchWord)) + ''))
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif =  N'' + ltrim(rtrim(@TextSearchWord)) + ''))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani =  N'' + ltrim(rtrim(@TextSearchWord)) + ''))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM =  N'' + ltrim(rtrim(@TextSearchWord)) + ''))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif =  N'' + ltrim(rtrim(@TextSearchWord)) + ''))
	)
GROUP BY WordOthmani
 For XML PATH ('')
) 
END
ELSE
BEGIN
SET @SearchedWords =
(
SELECT     DISTINCT WordOthmani   
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
	AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
	AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
	AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + '') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
	)
GROUP BY WordOthmani
 
) 
END


-- send the results :

SELECT @WordQty AS WordQty,@VerseQty AS VerseQty, @SearchedWords AS SearchedWords


GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByRoot_Table]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByRoot_Table]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-02
Last Modified:		2015-04-17
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@RootWord		nvarchar(50)

AS


DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

SELECT     COUNT(WordID) AS WCount
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND ([Root] =  N'' + ltrim(rtrim(@RootWord)) + '')






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByRoot_Table_Dr]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByRoot_Table_Dr]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-18
Last Modified:		2015-04-18
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@RootWord		nvarchar(50)

AS


DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int, @SearchedWords nvarchar(max)

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)
--, COUNT(WordID) as VerseQty
DECLARE @WordQty int, @VerseQty int

SET @WordQty = (
SELECT     COUNT(WordID) AS WordQty
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND ([Root] =  N'' + ltrim(rtrim(@RootWord)) + '')
 )
 
SET @VerseQty =
(
SELECT COUNT(VerseQty) FROM
(
SELECT     COUNT(VerseID) AS VerseQty
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND ([Root] =  N'' + ltrim(rtrim(@RootWord)) + '')
 GROUP BY VerseOrder
) AS Sql_Query1
)

if (@WordQty > 1)
BEGIN
SET @SearchedWords =
(
SELECT     DISTINCT '-'+ WordOthmani  AS [text()] 
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
			AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
			AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran) 
			AND (Root = N'' + LTRIM(RTRIM(@RootWord)) + '')
GROUP BY WordOthmani
 For XML PATH ('')
) 
END
ELSE
BEGIN
SET @SearchedWords =
(
SELECT     DISTINCT WordOthmani   
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
			AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
			AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran) 
			AND (Root = N'' + LTRIM(RTRIM(@RootWord)) + '')
GROUP BY WordOthmani
 
) 
END


SELECT @WordQty AS WordQty,@VerseQty AS VerseQty, @SearchedWords AS SearchedWords


GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByWordSentence]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByWordSentence]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-22
Last Modified:		2015-04-22
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20)

AS

-- @SearchCriteria : 
-- Word Dictional Criteria : DictNMAlif , DictNM 
-- Word Othmani Criteria : OthmNMAlif , OthmNM , Othm
-- DB FIELDS : WordOthmani , WordOthmaniNM , WordOthmaniNMAlif , WordDictNM , WordDictNMAlif



DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

SELECT     COUNT(WordID) AS WCount
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByWordSentence_Dr]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO





CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByWordSentence_Dr]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-22
Last Modified:		2015-04-22
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20)

AS

-- @SearchCriteria : 
-- Word Dictional Criteria : DictNMAlif , DictNM 
-- Word Othmani Criteria : OthmNMAlif , OthmNM , Othm
-- DB FIELDS : WordOthmani , WordOthmaniNM , WordOthmaniNMAlif , WordDictNM , WordDictNMAlif

DECLARE @WordQty int, @VerseQty int
DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int, @SearchedWords nvarchar(max)

-- get VERSE ORDER in WHOLE Quran
BEGIN

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

END


BEGIN


SET @WordQty = 
(
SELECT     COUNT(WordID) AS WCount
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
)
END
 
-- get Verse Quantity : 
SET @VerseQty =
(
SELECT COUNT(VerseQty) 
FROM(
SELECT     COUNT(VerseID) AS VerseQty
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
 GROUP BY VerseID
) AS Sql_Query1
)

-- to control the repeating of seperator '-'
-- if one word we do not need seperator

if (@WordQty > 1)
BEGIN
SET @SearchedWords =
(
SELECT     DISTINCT '-'+ WordOthmani  AS [text()] 
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
	AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
	AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
GROUP BY WordOthmani
 For XML PATH ('')
) 
END
ELSE
BEGIN
SET @SearchedWords =
(
SELECT     DISTINCT WordOthmani   
FROM         itinfo_QuranArabicWordsAll
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
	AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
	AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
	AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
GROUP BY WordOthmani
 
) 
END


-- send the results :

SELECT @WordQty AS WordQty,@VerseQty AS VerseQty, @SearchedWords AS SearchedWords



GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByWordVerse]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByWordVerse]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-22
Last Modified:		2015-04-22
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20)

AS

-- @SearchCriteria : 
-- Word Dictional Criteria : DictNMAlif , DictNM 
-- Word Othmani Criteria : OthmNMAlif , OthmNM , Othm
-- DB FIELDS : WordOthmani , WordOthmaniNM , WordOthmaniNMAlif , WordDictNM , WordDictNMAlif



DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)



SELECT    COUNT(VerseID) AS resCount
FROM         itinfo_View_iSearch_Default
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (SortOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (VerseText LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)






GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Default_ByWordVerse_Dr]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Default_ByWordVerse_Dr]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-22
Last Modified:		2015-04-23
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20)

AS

-- @SearchCriteria : 
-- Word Dictional Criteria : DictNMAlif , DictNM 
-- Word Othmani Criteria : OthmNMAlif , OthmNM , Othm
-- DB FIELDS : WordOthmani , WordOthmaniNM , WordOthmaniNMAlif , WordDictNM , WordDictNMAlif

DECLARE @WordsQty int, @VerseQty int
DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int, @SearchedWords nvarchar(max)

-- get VERSE ORDER in WHOLE Quran
BEGIN

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

END


BEGIN


SET @WordsQty = 
(
SELECT     COUNT(VerseID) AS resCount
FROM         itinfo_View_iSearch_Default
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (SortOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
  AND 
	(
	 (@SearchCriteria = 'DictNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (VerseText LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
)
END
 
-- get Verse Quantity : 
SET @VerseQty =
(
SELECT COUNT(VerseQty) 
FROM(
SELECT     COUNT(VerseID) AS VerseQty
FROM         itinfo_View_iSearch_Default
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (SortOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
  AND 
	(
	 (@SearchCriteria = 'DictNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (VerseText LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
 GROUP BY VerseID
) AS Sql_Query1
)

-- to control the repeating of seperator '-'


if (@SearchCriteria = 'DictNMAlif') OR (@SearchCriteria = 'OthmNMAlif')
begin
	SET @SearchedWords =
	(
	SELECT  DISTINCT '-'+ 
	 SUBSTRING(VerseTextNMAlif, CHARINDEX(@TextSearchWord, VerseTextNMAlif), LEN(@TextSearchWord)) AS [text()] 
	FROM         itinfo_View_iSearch_Default 
	WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
		AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
		AND (SortOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
		 AND 
		(
	   (@SearchCriteria = 'DictNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
	  OR (@SearchCriteria = 'OthmNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
		)
	GROUP BY SUBSTRING(VerseTextNMAlif, CHARINDEX(@TextSearchWord, VerseTextNMAlif), LEN(@TextSearchWord))
	 For XML PATH ('')

	) 
 end
else
if (@SearchCriteria = 'DictNM') OR (@SearchCriteria = 'OthmNM')
begin
	SET @SearchedWords =
	(
	SELECT  DISTINCT '-'+ 
	 SUBSTRING(VerseTextNM, CHARINDEX(@TextSearchWord, VerseTextNM), LEN(@TextSearchWord)) AS [text()] 
	FROM         itinfo_View_iSearch_Default 
	WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
		AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
		AND (SortOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
		 AND 
		(
		 (@SearchCriteria = 'DictNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%') )
	  OR (@SearchCriteria = 'OthmNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%'))
		)
	GROUP BY SUBSTRING(VerseTextNM, CHARINDEX(@TextSearchWord, VerseTextNM), LEN(@TextSearchWord))
	 For XML PATH ('')

	) 
 end
else
if (@SearchCriteria = 'Othm') 
begin
	SET @SearchedWords =
	(
	SELECT  DISTINCT '-'+ 
	 SUBSTRING(VerseText, CHARINDEX(@TextSearchWord, VerseText), LEN(@TextSearchWord)) AS [text()] 
	FROM         itinfo_View_iSearch_Default 
	WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
		AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
		AND (SortOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
		 AND 
	   (@SearchCriteria = 'Othm' AND (VerseText LIKE N'%' + @TextSearchWord + '%'))
	GROUP BY SUBSTRING(VerseText, CHARINDEX(@TextSearchWord, VerseText), LEN(@TextSearchWord))
	 For XML PATH ('')

	) 
 end



SELECT @WordsQty AS WordQty,@VerseQty AS VerseQty, @SearchedWords AS SearchedWords




GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_GetCount_Translation_ByWordSentence]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO







CREATE PROCEDURE [dbo].[itinfo_iSearch_GetCount_Translation_ByWordSentence]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-02
Last Modified:		2015-04-21
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250)

AS

-- search within translations
DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT     QV.SortOrderInQuran
FROM         itinfo_QuranVerses AS QV LEFT OUTER JOIN
                      itinfo_QuranVersesTranslation  AS QVT 
                      ON QV.VerseID = QVT.VerseID
WHERE     (QV.SiteID = @SiteID) 
AND (QV.VerseOrder = @StrtVerseSortOrder) 
AND (QVT.SuraID = @StrtSuraID) 
AND (QVT.QuranID = @QuranID)
GROUP BY QV.SortOrderInQuran
)

SET @EndVerseSortOrderInQuran =
(
SELECT     QV.SortOrderInQuran
FROM         itinfo_QuranVerses AS QV LEFT OUTER JOIN
                      itinfo_QuranVersesTranslation AS QVT 
                      ON QV.VerseID = QVT.VerseID
WHERE     (QV.SiteID = @SiteID) 
			AND (QV.VerseOrder = @EndVerseSortOrder) 
			AND (QVT.SuraID = @EndSuraID) 
			AND (QVT.QuranID = @QuranID)
GROUP BY QV.SortOrderInQuran
)

--select @StrtVerseSortOrderInQuran ,@EndVerseSortOrderInQuran
--SET @TextSearchWord = N'"' + @TextSearchWord + '"'

SELECT     COUNT(VerseID) AS CountVerses
FROM         itinfo_QuranVersesTranslation
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
AND (VerseText LIKE N'%' + ltrim(rtrim(@TextSearchWord)) + '%')

--AND CONTAINS(VerseText, @TextSearchWord)










GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_SelectPage_Default_ByOnlyWord]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iSearch_SelectPage_Default_ByOnlyWord]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-21
Last Modified:		2015-04-21
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20),
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int



SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseID Int
)

BEGIN 


INSERT INTO #PageIndex (VerseID)
SELECT     VerseID
FROM         itinfo_QuranArabicWordsAll AS QAW
WHERE     (SiteID = @SiteID) 
		AND (QuranID = @QuranID) 
		AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
		AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran) 
		AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + '') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif =  N'' + ltrim(rtrim(@TextSearchWord	)) + ''))
	)
GROUP BY VerseID, SuraOrder, VerseOrder
ORDER BY SuraOrder, VerseOrder

END 


SELECT  t1.*, t2.IndexID as VerseNo
FROM	itinfo_View_iSearch_Default AS t1

JOIN			#PageIndex As t2
ON t1.VerseID = t2.VerseID
WHERE
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID) 
AND (t2.IndexID > @PageLowerBound)
AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID

DROP TABLE #PageIndex








GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_SelectPage_Default_ByRoot_Table]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO








CREATE PROCEDURE [dbo].[itinfo_iSearch_SelectPage_Default_ByRoot_Table]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-02
Last Modified:		2015-04-17
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@RootWord		nvarchar(50),
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int



SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseID Int
)

BEGIN 


INSERT INTO #PageIndex (VerseID)
SELECT     VerseID
FROM         itinfo_QuranArabicWordsAll AS QAW
WHERE     (SiteID = @SiteID) 
		AND (QuranID = @QuranID) 
		AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
		AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran) 
		AND (Root = N'' + LTRIM(RTRIM(@RootWord)) + '')
GROUP BY VerseID, SuraOrder, VerseOrder
ORDER BY SuraOrder, VerseOrder

END 


SELECT  t1.*, t2.IndexID as VerseNo
FROM	itinfo_View_iSearch_Default AS t1

JOIN			#PageIndex As t2
ON t1.VerseID = t2.VerseID
WHERE
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID) 
AND (t2.IndexID > @PageLowerBound)
AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID

DROP TABLE #PageIndex








GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_SelectPage_Default_ByWordSentence]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[itinfo_iSearch_SelectPage_Default_ByWordSentence]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-22
Last Modified:		2015-04-22
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20),
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int



SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseID Int
)

BEGIN 


INSERT INTO #PageIndex (VerseID)
SELECT     VerseID
FROM         itinfo_QuranArabicWordsAll AS QAW
WHERE     (SiteID = @SiteID) 
		AND (QuranID = @QuranID) 
		AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
		AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran) 
		AND 
	(
	 (@SearchCriteria = 'DictNM' AND (WordDictNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (WordDictNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (WordOthmani LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (WordOthmaniNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (WordOthmaniNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
GROUP BY VerseID, SuraOrder, VerseOrder
ORDER BY SuraOrder, VerseOrder

END 


SELECT  t1.*, t2.IndexID as VerseNo
FROM	itinfo_View_iSearch_Default AS t1

JOIN			#PageIndex As t2
ON t1.VerseID = t2.VerseID
WHERE
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID) 
AND (t2.IndexID > @PageLowerBound)
AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID

DROP TABLE #PageIndex









GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_SelectPage_Default_ByWordVerse]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[itinfo_iSearch_SelectPage_Default_ByWordVerse]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-22
Last Modified:		2015-04-22
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@SearchCriteria	nchar(20),
@PageNumber 	int,
@PageSize 		int

AS

DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@StrtSuraID) 
AND (VerseOrder = @StrtVerseSortOrder)
)

SET @EndVerseSortOrderInQuran =
(
SELECT SortOrderInQuran 
FROM itinfo_QuranVerses 
WHERE (SiteID = @SiteID) AND (QuranID = @QuranID) AND (SuraID =@EndSuraID) 
AND (VerseOrder = @EndVerseSortOrder)
)

DECLARE @PageLowerBound int
DECLARE @PageUpperBound int



SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1

/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseID Int
)

BEGIN 


INSERT INTO #PageIndex (VerseID)
SELECT     VerseID
	FROM         itinfo_View_iSearch_Default 
WHERE     (SiteID = @SiteID) 
		AND (QuranID = @QuranID) 
		AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
		AND (SortOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran) 
		 AND 
	(
	 (@SearchCriteria = 'DictNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%') )
  OR (@SearchCriteria = 'DictNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'Othm' AND (VerseText LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNM' AND (VerseTextNM LIKE N'%' + @TextSearchWord + '%'))
  OR (@SearchCriteria = 'OthmNMAlif' AND (VerseTextNMAlif LIKE N'%' + @TextSearchWord + '%'))
	)
GROUP BY VerseID, SuraOrder, VerseOrder
ORDER BY SuraOrder, VerseOrder

END 


SELECT  t1.*, t2.IndexID as VerseNo
FROM	itinfo_View_iSearch_Default AS t1

JOIN			#PageIndex As t2
ON t1.VerseID = t2.VerseID
WHERE
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID) 
AND (t2.IndexID > @PageLowerBound)
AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID

DROP TABLE #PageIndex










GO

/****** Object:  StoredProcedure [dbo].[itinfo_iSearch_SelectPage_Translation_ByWordSentence]    Script Date: 05/09/2015 17:35:50 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO






CREATE PROCEDURE [dbo].[itinfo_iSearch_SelectPage_Translation_ByWordSentence]

/*
Author:				Ghalib Ghniem - ghalib@ItInfoPlus.com
Created:			2015-04-02
Last Modified:		2015-04-20
*/

@SiteID				int,
@QuranID			int,
@StrtSuraID		int,
@EndSuraID		int,
@StrtVerseSortOrder		int,
@EndVerseSortOrder		int,
@TextSearchWord		nvarchar(250),
@PageNumber 	int,
@PageSize 		int

AS



DECLARE @PageLowerBound int
DECLARE @PageUpperBound int



SET @PageLowerBound = (@PageSize * @PageNumber) - @PageSize
SET @PageUpperBound = @PageLowerBound + @PageSize + 1





-- search within translations
DECLARE @StrtVerseSortOrderInQuran int, @EndVerseSortOrderInQuran int

SET @StrtVerseSortOrderInQuran = 
(
SELECT     QV.SortOrderInQuran
FROM         itinfo_QuranVerses AS QV LEFT OUTER JOIN
                      itinfo_QuranVersesTranslation  AS QVT 
                      ON QV.VerseID = QVT.VerseID
WHERE     (QV.SiteID = @SiteID) 
AND (QV.VerseOrder = @StrtVerseSortOrder) 
AND (QVT.SuraID = @StrtSuraID) 
AND (QVT.QuranID = @QuranID)
GROUP BY QV.SortOrderInQuran
)

SET @EndVerseSortOrderInQuran =
(
SELECT     QV.SortOrderInQuran
FROM         itinfo_QuranVerses AS QV LEFT OUTER JOIN
                      itinfo_QuranVersesTranslation AS QVT 
                      ON QV.VerseID = QVT.VerseID
WHERE     (QV.SiteID = @SiteID) 
			AND (QV.VerseOrder = @EndVerseSortOrder) 
			AND (QVT.SuraID = @EndSuraID) 
			AND (QVT.QuranID = @QuranID)
GROUP BY QV.SortOrderInQuran
)

-- SELECT  @StrtVerseSortOrderInQuran , @EndVerseSortOrderInQuran



/*
Note: temp tables use the server default for collation not the database default
so if adding character columns be sure and specify to use the database collation like this
to avoid collation errors:

CREATE TABLE #PageIndexForUsers
(
IndexID int IDENTITY (1, 1) NOT NULL,
UserName nvarchar(50) COLLATE DATABASE_DEFAULT,
LoginName nvarchar(50) COLLATE DATABASE_DEFAULT
)


*/

CREATE TABLE #PageIndex
(
IndexID int IDENTITY (1, 1) NOT NULL,
VerseOrderInQuran Int
)

BEGIN 


INSERT INTO #PageIndex (VerseOrderInQuran)

SELECT     VerseOrderInQuran
FROM         itinfo_QuranVersesTranslation
WHERE     (SiteID = @SiteID) AND (QuranID = @QuranID) 
AND (SuraID BETWEEN @StrtSuraID AND @EndSuraID) 
AND (VerseOrderInQuran BETWEEN @StrtVerseSortOrderInQuran AND @EndVerseSortOrderInQuran)
AND (VerseText LIKE N'%' + ltrim(rtrim(@TextSearchWord)) + '%')
GROUP BY VerseOrder, SuraOrder,VerseOrderInQuran
ORDER BY SuraOrder, VerseOrder

-- AND CONTAINS(VerseText, @TextSearchWord)

END 


SELECT  t1.*, t2.IndexID as VerseNo
FROM	itinfo_View_iSearch_Translation AS t1

JOIN			#PageIndex As t2
ON t1.SortOrderInQuran = t2.VerseOrderInQuran
WHERE
(t1.SiteID = @SiteID) AND (t1.QuranID = @QuranID) 
AND (t2.IndexID > @PageLowerBound)
AND (t2.IndexID < @PageUpperBound)
ORDER BY t2.IndexID



DROP TABLE #PageIndex








GO


